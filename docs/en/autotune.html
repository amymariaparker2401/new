<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Automatic hyperparameter optimization · fastText</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="As we saw in [the tutorial](/docs/en/supervised-tutorial.html#more-epochs-and-larger-learning-rate), finding the best hyperparameters is crucial for building efficient models. However, searching the best hyperparameters manually is difficult. Parameters are dependent and the effect of each parameter vary from one dataset to another."/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Automatic hyperparameter optimization · fastText"/><meta property="og:type" content="website"/><meta property="og:url" content="https://fasttext.cc/index.html"/><meta property="og:description" content="As we saw in [the tutorial](/docs/en/supervised-tutorial.html#more-epochs-and-larger-learning-rate), finding the best hyperparameters is crucial for building efficient models. However, searching the best hyperparameters manually is difficult. Parameters are dependent and the effect of each parameter vary from one dataset to another."/><meta property="og:image" content="https://fasttext.cc/img/ogimage.png"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/img/fasttext-icon-bg-web.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="alternate" type="application/atom+xml" href="https://fasttext.cc/blog/atom.xml" title="fastText Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="https://fasttext.cc/blog/feed.xml" title="fastText Blog RSS Feed"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-44373548-30', 'auto');
              ga('send', 'pageview');
            </script><script type="text/javascript" src="/tabber.js"></script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/fasttext-icon-white-web.png" alt="fastText"/></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/docs/en/support.html" target="_self">Docs</a></li><li class=""><a href="/docs/en/english-vectors.html" target="_self">Resources</a></li><li class=""><a href="/blog/" target="_self">Blog</a></li><li class=""><a href="https://github.com/facebookresearch/fastText/" target="_blank">GitHub</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Help</span></h2></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Introduction</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/en/support.html">Get started</a></li><li class="navListItem"><a class="navItem" href="/docs/en/cheatsheet.html">Cheatsheet</a></li><li class="navListItem"><a class="navItem" href="/docs/en/options.html">List of options</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Tutorials</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/en/supervised-tutorial.html">Text classification</a></li><li class="navListItem"><a class="navItem" href="/docs/en/unsupervised-tutorial.html">Word representations</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Help</h3><ul class=""><li class="navListItem navListItemActive"><a class="navItem" href="/docs/en/autotune.html">Automatic hyperparameter optimization</a></li><li class="navListItem"><a class="navItem" href="/docs/en/python-module.html">Python module</a></li><li class="navListItem"><a class="navItem" href="/docs/en/webassembly-module.html">WebAssembly module</a></li><li class="navListItem"><a class="navItem" href="/docs/en/faqs.html">FAQ</a></li><li class="navListItem"><a class="navItem" href="/docs/en/api.html">API</a></li><li class="navListItem"><a class="navItem" href="/docs/en/references.html">References</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">Automatic hyperparameter optimization</h1></header><article><div><span><p>As we saw in <a href="/docs/en/supervised-tutorial.html#more-epochs-and-larger-learning-rate">the tutorial</a>, finding the best hyperparameters is crucial for building efficient models. However, searching the best hyperparameters manually is difficult. Parameters are dependent and the effect of each parameter vary from one dataset to another.</p>
<p>FastText's autotune feature allows you to find automatically the best hyperparameters for your dataset.</p>
<h1><a class="anchor" aria-hidden="true" id="how-to-use-it"></a><a href="#how-to-use-it" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How to use it</h1>
<p>In order to activate hyperparameter optimization, we must provide a validation file with the <code>-autotune-validation</code> argument.</p>
<p>For example, using the same data as our <a href="/docs/en/supervised-tutorial.html#our-first-classifier">tutorial example</a>, the autotune can be used in the following way:</p>
<div class="tabs"><div class="nav-tabs"><div id="tab-group-1-tab-2" class="nav-link active" data-group="group_1" data-tab="tab-group-1-content-2">Command line</div><div id="tab-group-1-tab-3" class="nav-link" data-group="group_1" data-tab="tab-group-1-content-3">Python</div></div><div class="tab-content"><div id="tab-group-1-content-2" class="tab-pane active" data-group="group_1" tabindex="-1"><div><span><pre><code class="hljs css language-sh">&gt;&gt; ./fasttext supervised -input cooking.train -output model_cooking -autotune-validation cooking.valid<br /></code></pre>
</span></div></div><div id="tab-group-1-content-3" class="tab-pane" data-group="group_1" tabindex="-1"><div><span><pre><code class="hljs css language-py"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> fasttext<br /><span class="hljs-meta">&gt;&gt;&gt; </span>model = fasttext.train_supervised(input=<span class="hljs-string">'cooking.train'</span>, autotuneValidationFile=<span class="hljs-string">'cooking.valid'</span>)<br /></code></pre>
</span></div></div></div></div>
<p>Then, fastText will search the hyperparameters that gives the best f1-score on <code>cooking.valid</code> file:</p>
<pre><code class="hljs css language-sh">Progress: 100.0% Trials:   27 Best score:  0.406763 ETA:   0h 0m 0s
</code></pre>
<p>Now we can test the obtained model with:</p>
<div class="tabs"><div class="nav-tabs"><div id="tab-group-4-tab-5" class="nav-link active" data-group="group_4" data-tab="tab-group-4-content-5">Command line</div><div id="tab-group-4-tab-6" class="nav-link" data-group="group_4" data-tab="tab-group-4-content-6">Python</div></div><div class="tab-content"><div id="tab-group-4-content-5" class="tab-pane active" data-group="group_4" tabindex="-1"><div><span><pre><code class="hljs css language-sh">&gt;&gt; ./fasttext <span class="hljs-built_in">test</span> model_cooking.bin cooking.valid<br />N       3000<br />P@1     0.666<br />R@1     0.288<br /></code></pre>
</span></div></div><div id="tab-group-4-content-6" class="tab-pane" data-group="group_4" tabindex="-1"><div><span><pre><code class="hljs css language-py"><span class="hljs-meta">&gt;&gt;&gt; </span>model.test(<span class="hljs-string">"cooking.valid"</span>)<br />(<span class="hljs-number">3000L</span>, <span class="hljs-number">0.666</span>, <span class="hljs-number">0.288</span>)<br /></code></pre>
</span></div></div></div></div>
<p>By default, the search will take 5 minutes. You can set the timeout in seconds with the <code>-autotune-duration</code> argument. For example, if you want to set the limit to 10 minutes:</p>
<div class="tabs"><div class="nav-tabs"><div id="tab-group-7-tab-8" class="nav-link active" data-group="group_7" data-tab="tab-group-7-content-8">Command line</div><div id="tab-group-7-tab-9" class="nav-link" data-group="group_7" data-tab="tab-group-7-content-9">Python</div></div><div class="tab-content"><div id="tab-group-7-content-8" class="tab-pane active" data-group="group_7" tabindex="-1"><div><span><pre><code class="hljs css language-sh">&gt;&gt; ./fasttext supervised -input cooking.train -output model_cooking -autotune-validation cooking.valid -autotune-duration 600<br /></code></pre>
</span></div></div><div id="tab-group-7-content-9" class="tab-pane" data-group="group_7" tabindex="-1"><div><span><pre><code class="hljs css language-py"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> fasttext<br /><span class="hljs-meta">&gt;&gt;&gt; </span>model = fasttext.train_supervised(input=<span class="hljs-string">'cooking.train'</span>, autotuneValidationFile=<span class="hljs-string">'cooking.valid'</span>, autotuneDuration=<span class="hljs-number">600</span>)<br /></code></pre>
</span></div></div></div></div>
<p>While autotuning, fastText displays the best f1-score found so far. If we decide to stop the tuning before the time limit, we can send one <code>SIGINT</code> signal (via <code>CTLR-C</code> for example). FastText will then finish the current training, and retrain with the best parameters found so far.</p>
<h1><a class="anchor" aria-hidden="true" id="constrain-model-size"></a><a href="#constrain-model-size" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Constrain model size</h1>
<p>As you may know, fastText can compress the model with <a href="/docs/en/cheatsheet.html#quantization">quantization</a>. However, this compression task comes with its own <a href="/docs/en/options.html">hyperparameters</a> (<code>-cutoff</code>, <code>-retrain</code>, <code>-qnorm</code>, <code>-qout</code>, <code>-dsub</code>) that have a consequence on the accuracy and the size of the final model.</p>
<p>Fortunately, autotune can also find the hyperparameters for this compression task while targeting the desired model size. To this end, we can set the <code>-autotune-modelsize</code> argument:</p>
<div class="tabs"><div class="nav-tabs"><div id="tab-group-10-tab-11" class="nav-link active" data-group="group_10" data-tab="tab-group-10-content-11">Command line</div><div id="tab-group-10-tab-12" class="nav-link" data-group="group_10" data-tab="tab-group-10-content-12">Python</div></div><div class="tab-content"><div id="tab-group-10-content-11" class="tab-pane active" data-group="group_10" tabindex="-1"><div><span><pre><code class="hljs css language-sh">&gt;&gt; ./fasttext supervised -input cooking.train -output model_cooking -autotune-validation cooking.valid -autotune-modelsize 2M<br /></code></pre>
<p>This will produce a <code>.ftz</code> file with the best accuracy having the desired size:</p>
<pre><code class="hljs css language-sh">&gt;&gt; ls -la model_cooking.ftz<br />-rw-r--r--. 1 celebio users 1990862 Aug 25 05:39 model_cooking.ftz<br />&gt;&gt; ./fasttext <span class="hljs-built_in">test</span> model_cooking.ftz cooking.valid<br />N       3000<br />P@1     0.57<br />R@1     0.246<br /></code></pre>
</span></div></div><div id="tab-group-10-content-12" class="tab-pane" data-group="group_10" tabindex="-1"><div><span><pre><code class="hljs css language-py"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> fasttext<br /><span class="hljs-meta">&gt;&gt;&gt; </span>model = fasttext.train_supervised(input=<span class="hljs-string">'cooking.train'</span>, autotuneValidationFile=<span class="hljs-string">'cooking.valid'</span>, autotuneModelSize=<span class="hljs-string">"2M"</span>)<br /></code></pre>
<p>If you save the model, you will obtain a model file with the desired size:</p>
<pre><code class="hljs css language-py"><span class="hljs-meta">&gt;&gt;&gt; </span>model.save_model(<span class="hljs-string">"model_cooking.ftz"</span>)<br /><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> os<br /><span class="hljs-meta">&gt;&gt;&gt; </span>os.stat(<span class="hljs-string">"model_cooking.ftz"</span>).st_size<br /><span class="hljs-number">1990862</span><br /><span class="hljs-meta">&gt;&gt;&gt; </span>model.test(<span class="hljs-string">"cooking.valid"</span>)<br />(<span class="hljs-number">3000L</span>, <span class="hljs-number">0.57</span>, <span class="hljs-number">0.246</span>)<br /></code></pre>
</span></div></div></div></div>
<h1><a class="anchor" aria-hidden="true" id="how-to-set-the-optimization-metric"></a><a href="#how-to-set-the-optimization-metric" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How to set the optimization metric?</h1>
<div class="tabs"><div class="nav-tabs"><div id="tab-group-13-tab-14" class="nav-link active" data-group="group_13" data-tab="tab-group-13-content-14">Command line</div><div id="tab-group-13-tab-15" class="nav-link" data-group="group_13" data-tab="tab-group-13-content-15">Python</div></div><div class="tab-content"><div id="tab-group-13-content-14" class="tab-pane active" data-group="group_13" tabindex="-1"><div><span><p><br />
By default, autotune will test the validation file you provide, exactly the same way as <code>./fasttext test model_cooking.bin cooking.valid</code> and try to optimize to get the highest <a href="https://en.wikipedia.org/wiki/F1_score">f1-score</a>.</p>
<p>But, if we want to optimize the score of a specific label, say <code>__label__baking</code>, we can set the <code>-autotune-metric</code> argument:</p>
<pre><code class="hljs css language-sh">&gt;&gt; ./fasttext supervised -input cooking.train -output model_cooking -autotune-validation cooking.valid -autotune-metric f1:__label__baking<br /></code></pre>
<p>This is equivalent to manually optimize the f1-score we get when we test with <code>./fasttext test-label model_cooking.bin cooking.valid | grep __label__baking</code> in command line.</p>
<p>Sometimes, you may be interested in predicting more than one label. For example, if you were optimizing the hyperparameters manually to get the best score to predict two labels, you would test with <code>./fasttext test model_cooking.bin cooking.valid 2</code>. You can also tell autotune to optimize the parameters by testing two labels with the <code>-autotune-predictions</code> argument.</p>
</span></div></div><div id="tab-group-13-content-15" class="tab-pane" data-group="group_13" tabindex="-1"><div><span><p><br />
By default, autotune will test the validation file you provide, exactly the same way as <code>model.test(&quot;cooking.valid&quot;)</code> and try to optimize to get the highest <a href="https://en.wikipedia.org/wiki/F1_score">f1-score</a>.</p>
<p>But, if we want to optimize the score of a specific label, say <code>__label__baking</code>, we can set the <code>autotuneMetric</code> argument:</p>
<pre><code class="hljs css language-py"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> fasttext<br /><span class="hljs-meta">&gt;&gt;&gt; </span>model = fasttext.train_supervised(input=<span class="hljs-string">'cooking.train'</span>, autotuneValidationFile=<span class="hljs-string">'cooking.valid'</span>, autotuneMetric=<span class="hljs-string">"f1:__label__baking"</span>)<br /></code></pre>
<p>This is equivalent to manually optimize the f1-score we get when we test with <code>model.test_label('cooking.valid')['__label__baking']</code>.</p>
<p>Sometimes, you may be interested in predicting more than one label. For example, if you were optimizing the hyperparameters manually to get the best score to predict two labels, you would test with <code>model.test(&quot;cooking.valid&quot;, k=2)</code>. You can also tell autotune to optimize the parameters by testing two labels with the <code>autotunePredictions</code> argument.</p>
</span></div></div></div></div>
<p>You can also force autotune to optimize for the best precision for a given recall, or the best recall for a given precision, for all labels, or for a specific label:</p>
<p>For example, in order to get the best precision at recall = <code>30%</code>:</p>
<pre><code class="hljs css language-sh">&gt;&gt; ./fasttext supervised [...] -autotune-metric precisionAtRecall:30
</code></pre>
<p>And to get the best precision at recall = <code>30%</code> for the label <code>__label__baking</code>:</p>
<pre><code class="hljs css language-sh">&gt;&gt; ./fasttext supervised [...] -autotune-metric precisionAtRecall:30:__label__baking
</code></pre>
<p>Similarly, you can use <code>recallAtPrecision</code>:</p>
<pre><code class="hljs css language-sh">&gt;&gt; ./fasttext supervised [...] -autotune-metric recallAtPrecision:30
&gt;&gt; ./fasttext supervised [...] -autotune-metric recallAtPrecision:30:__label__baking
</code></pre>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/en/unsupervised-tutorial.html"><span class="arrow-prev">← </span><span>Word representations</span></a><a class="docs-next button" href="/docs/en/python-module.html"><span>Python module</span><span class="arrow-next"> →</span></a></div></div></div></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/fasttext-icon-white-web.png" alt="fastText"/></a><div><h5>Support</h5><a href="/docs/en/support.html">Getting Started</a><a href="/docs/en/supervised-tutorial.html">Tutorials</a><a href="/docs/en/faqs.html">FAQs</a><a href="/docs/en/api.html">API</a></div><div><h5>Community</h5><a href="https://www.facebook.com/groups/1174547215919768/" target="_blank">Facebook Group</a><a href="http://stackoverflow.com/questions/tagged/fasttext" target="_blank">Stack Overflow</a><a href="https://groups.google.com/forum/#!forum/fasttext-library" target="_blank">Google Group</a></div><div><h5>More</h5><a href="/blog">Blog</a><a href="https://github.com/facebookresearch/fastText" target="_blank">GitHub</a><a class="github-button" href="https://github.com/facebookresearch/fastText/" data-icon="octicon-star" data-count-href="/fastText/stargazers" data-count-api="/repos/fastText#stargazers_count" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a></div></section><a href="https://code.facebook.com/projects/" target="_blank" class="fbOpenSource"><img src="/img/oss_logo.png" alt="Facebook Open Source" width="170" height="45"/></a><section class="copyright">Copyright © 2020 Facebook Inc.</section></footer></div></body></html>